name: Continuous Integration

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test-and-lint:
    runs-on: ubuntu-latest

    # Variáveis de ambiente para o ambiente de CI
    env:
      DATABASE_URL: postgresql://admin:password@localhost:5432/meuat_geo
      PYTHONPATH: ${{ github.workspace }}/api

    services:
      # Sobe um banco PostGIS real para os testes de integração
      db:
        image: postgis/postgis:15-3.3
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: password
          POSTGRES_DB: meuat_geo
        ports:
          - 5432:5432
        # Garante que o banco esteja saudável antes de iniciar os steps
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip" # Otimiza o tempo de build cacheando dependências

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest httpx
          if [ -f api/requirements.txt ]; then pip install -r api/requirements.txt; fi

      - name: Run Lint (Flake8)
        run: |
          # O flake8 lerá automaticamente o arquivo .flake8 da raiz
          # O build falhará se houver qualquer erro não ignorado
          flake8 . --count --statistics

      - name: Run Tests (Pytest)
        run: |
          # Entra na pasta api para rodar os testes com o contexto correto
          cd api 
          python -m pytest tests/
